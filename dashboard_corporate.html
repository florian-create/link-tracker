<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Tracker - Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            line-height: 1.6;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        .header {
            background: #111;
            border-bottom: 1px solid #222;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            overflow-x: hidden;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
            letter-spacing: -0.5px;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .logo-subtitle {
            font-size: 0.5rem;
            font-weight: 400;
            color: #666;
            letter-spacing: 0.5px;
            text-transform: lowercase;
        }

        .time-filter {
            display: flex;
            gap: 0.5rem;
            background: #1a1a1a;
            padding: 0.25rem;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
        }

        .time-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .time-btn:hover {
            color: #fff;
            background: #252525;
        }

        .time-btn.active {
            background: #333;
            color: #fff;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
            overflow-x: hidden;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            width: 100%;
        }

        .stat-card {
            background: #111;
            border: 1px solid #222;
            padding: 1.5rem;
            border-radius: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            line-height: 1;
        }

        .stat-change {
            font-size: 0.875rem;
            color: #4ade80;
            margin-top: 0.5rem;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            width: 100%;
            overflow-x: hidden;
        }

        .chart-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 4px;
            padding: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            min-height: 21px;
        }

        .chart-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        .heatmap-card {
            background: transparent;
            border: 1px solid #222;
            border-radius: 4px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .heatmap-card .chart-title {
            color: #fff;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 1px;
            margin-top: 1rem;
            max-width: 700px;
            font-size: 0.75rem;
            background: transparent;
        }

        .heatmap-label {
            font-size: 0.7rem;
            color: #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 0;
            line-height: 1;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .heatmap-day {
            font-size: 0.7rem;
            color: #e5e5e5;
            text-align: center;
            padding: 0.3rem 0;
            font-weight: 300;
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .heatmap-cell {
            width: 100%;
            height: 24px;
            background: #1a1a1a;
            border-radius: 0;
            cursor: pointer;
            transition: opacity 0.2s;
            border: none;
        }

        .heatmap-cell:hover {
            opacity: 0.8;
        }

        .table-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 4px;
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-actions {
            display: flex;
            gap: 1rem;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 3px;
            font-size: 0.875rem;
            color: #e5e5e5;
            cursor: pointer;
            outline: none;
        }

        .export-btn {
            padding: 0.5rem 1.25rem;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #e5e5e5;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #0a0a0a;
        }

        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #222;
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #1a1a1a;
            font-size: 0.875rem;
        }

        tbody tr:hover {
            background: #0f0f0f;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #14532d;
            color: #4ade80;
        }

        .badge-gray {
            background: #1a1a1a;
            color: #666;
        }

        .badge-campaign {
            background: #1a1a2e;
            color: #60a5fa;
        }

        .click-count {
            font-weight: 700;
            color: #fff;
        }

        .delete-btn {
            background: transparent;
            border: 1px solid #333;
            color: #888;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #dc2626;
            border-color: #dc2626;
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .geo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .geo-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            gap: 0.75rem;
            border-bottom: 1px solid #1a1a1a;
        }

        .geo-item:last-child {
            border-bottom: none;
        }

        .geo-rank {
            font-size: 0.7rem;
            color: #666;
            min-width: 20px;
            text-align: right;
            font-weight: 300;
        }

        .geo-person {
            flex: 1;
            font-size: 0.8rem;
            color: #e5e5e5;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .geo-bar {
            flex: 2;
            height: 20px;
            background: transparent;
            position: relative;
            margin: 0;
        }

        .geo-bar-fill {
            height: 100%;
            border-radius: 0;
            transition: width 0.3s ease;
        }

        .geo-count {
            font-size: 0.75rem;
            color: #888;
            font-weight: 300;
            min-width: 50px;
            text-align: right;
        }

        /* Sankey styles */
        #sankeyChart {
            width: 100%;
            height: 100%;
            min-height: 450px;
        }

        .sankey-node rect {
            rx: 2;
            ry: 2;
            stroke: #444;
            stroke-opacity: 0.6;
            stroke-width: 1;
        }

        .sankey-node text {
            font-size: 10px;
            font-weight: 500;
            pointer-events: none;
            fill: #e5e5e5;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
        }

        .sankey-link {
            fill: none;
            stroke-opacity: 0.35;
        }

        .sankey-link:hover {
            stroke-opacity: 0.65;
        }

        .sankey-tooltip {
            position: absolute;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            display: none;
            border: 1px solid #333;
            z-index: 1000;
        }

        @media (max-width: 1024px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 1rem;
            }

            .header-content {
                gap: 0.75rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .header-content > div {
                width: 100%;
                max-width: 100%;
                min-width: 0;
            }

            .filter-select {
                min-width: 0 !important;
                width: 100%;
            }

            .time-filter {
                min-width: 0 !important;
                width: 100%;
            }

            .chart-card {
                min-height: 400px;
                padding: 1rem;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .filter-select {
                width: 100%;
                font-size: 0.875rem;
            }

            .time-filter {
                width: 100%;
                justify-content: stretch;
            }

            .time-btn {
                flex: 1;
                padding: 0.5rem 0.5rem;
                font-size: 0.75rem;
            }

            /* Make table scrollable on mobile */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 800px;
                font-size: 0.875rem;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }

            .badge {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }

            .export-btn {
                width: 100%;
                justify-content: center;
                font-size: 0.875rem;
                padding: 0.75rem 1rem;
            }

            /* Sankey and ICP charts side by side on tablet */
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .logo {
                font-size: 1rem;
            }

            .logo-subtitle {
                font-size: 0.45rem;
            }

            .container {
                padding: 0.5rem;
            }

            .header {
                padding: 0.75rem 0.5rem;
            }

            .header-content > div:last-child {
                flex-direction: column;
                gap: 0.5rem;
            }

            .filter-select,
            .time-filter {
                width: 100% !important;
                flex: none !important;
            }

            /* Stats en colonne simple sur mobile */
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem;
            }

            .stat-card {
                min-width: 0;
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .chart-title {
                font-size: 0.9rem;
            }

            .chart-card {
                min-height: 350px;
                padding: 0.75rem;
            }

            /* Stack time filter vertically on very small screens */
            .time-filter {
                flex-direction: column;
                padding: 0.5rem;
            }

            .time-btn {
                width: 100%;
                text-align: center;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 0.5rem 0.35rem;
            }

            .action-btn {
                padding: 0.35rem 0.5rem;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.75rem;
            }

            .chart-card {
                min-height: 300px;
            }

            /* Further reduce table on very small screens */
            table {
                font-size: 0.75rem;
                min-width: 700px;
            }

            th, td {
                padding: 0.4rem 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span>LINK TRACKER</span>
                <span class="logo-subtitle">by aura</span>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; width: 100%; max-width: 100%;">
                <select class="filter-select" id="globalCampaignFilter" style="flex: 1; min-width: 0;">
                </select>
                <div class="time-filter" style="flex: 1; min-width: 0;">
                    <button class="time-btn" data-range="24h">24H</button>
                    <button class="time-btn" data-range="7d">7D</button>
                    <button class="time-btn active" data-range="30d">30D</button>
                    <button class="time-btn" data-range="all">ALL</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">Loading...</div>
        </div>

        <!-- Charts Grid -->
        <div class="chart-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Click Timeline</div>
                </div>
                <canvas id="timelineChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Top Clickers</div>
                </div>
                <ul class="geo-list" id="geoList">
                    <li class="loading">Loading...</li>
                </ul>
            </div>
        </div>

        <!-- Heatmap and Sankey -->
        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div class="chart-card" style="min-height: 700px; display: flex; flex-direction: column; width: fit-content;">
                <div class="chart-header">
                    <div class="chart-title">Click Activity Heatmap (Unique Visitors)</div>
                </div>
                <div id="heatmapContainer" style="flex: 1; display: flex; align-items: center;">
                    <div class="loading">Loading heatmap...</div>
                </div>
            </div>

            <div class="chart-card" style="min-height: 700px; display: flex; flex-direction: column;">
                <div class="chart-header">
                    <div class="chart-title">Conversion Funnel</div>
                </div>
                <div id="sankeyChart" style="flex: 1;"></div>
                <div class="sankey-tooltip" id="sankeyTooltip"></div>
            </div>

            <div class="chart-card" style="min-height: 700px; display: flex; flex-direction: column; min-width: 350px;">
                <div class="chart-header">
                    <div class="chart-title">ICP Distribution (Clicked)</div>
                </div>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <canvas id="icpChart" style="max-width: 300px; max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-card">
            <div class="table-header">
                <h2 class="table-title">Click Details</h2>
                <div class="table-actions">
                    <button class="export-btn" onclick="exportCSV()">EXPORT CSV</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>ICP</th>
                            <th>Campaign</th>
                            <th>Clicks</th>
                            <th>First Click</th>
                            <th>Last Click</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clicksTable">
                        <tr><td colspan="9" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Restore saved state from localStorage
        let currentRange = localStorage.getItem('selectedRange') || '30d';
        let currentCampaign = localStorage.getItem('selectedCampaign') || '';
        let allClicks = [];
        let timelineChart = null;
        let icpChart = null;
        let sankeyData = { totalLinks: 0, totalClicks: 0, uniqueVisitors: 0 };

        // Time filter buttons
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRange = btn.dataset.range;
                localStorage.setItem('selectedRange', currentRange);
                loadAllData();
            });
        });

        // Global campaign filter
        document.getElementById('globalCampaignFilter').addEventListener('change', (e) => {
            currentCampaign = e.target.value;
            localStorage.setItem('selectedCampaign', currentCampaign);
            loadAllData();
        });

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadAnalytics(),
                loadTimeline(),
                loadHeatmap(),
                loadClicks(),
                loadCampaigns(),
                loadICPStats()
            ]);
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                let url = `/api/analytics?range=${currentRange}`;
                if (currentCampaign) {
                    url += `&campaign=${currentCampaign}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Total Links</div>
                        <div class="stat-value">${data.total_links.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Clicks</div>
                        <div class="stat-value">${data.total_clicks.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unique Visitors</div>
                        <div class="stat-value">${data.unique_clicks.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Click Rate</div>
                        <div class="stat-value">${data.click_rate}%</div>
                    </div>
                `;

                // Update geo data
                renderGeoData(data.geo_data);

                // Update Sankey chart
                renderSankey(data.total_links, data.total_clicks, data.unique_clicks);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Render Sankey (funnel visualization with D3)
        function renderSankey(totalLinks, totalClicks, uniqueVisitors) {
            // Store data for potential use
            sankeyData = { totalLinks, totalClicks, uniqueVisitors };

            // Clear previous chart
            const container = d3.select('#sankeyChart');
            container.selectAll('*').remove();

            // Get container dimensions
            const containerNode = container.node();
            if (!containerNode) return;

            const width = containerNode.getBoundingClientRect().width;
            const height = containerNode.getBoundingClientRect().height || 600;

            // Create SVG
            const svg = container.append('svg')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('preserveAspectRatio', 'xMidYMid meet');

            // Prepare Sankey data - simplified flow
            const clickedLinks = Math.max(1, uniqueVisitors); // Only count unique visitors as "clicked"
            const unclickedLinks = Math.max(1, totalLinks - clickedLinks);

            const data = {
                nodes: [
                    { id: "TOTAL LINKS" },
                    { id: "CLICKED" },
                    { id: "NOT CLICKED" },
                    { id: "UNIQUE VISITORS" }
                ],
                links: [
                    { source: "TOTAL LINKS", target: "CLICKED", value: clickedLinks, type: "success" },
                    { source: "TOTAL LINKS", target: "NOT CLICKED", value: unclickedLinks, type: "failure" },
                    { source: "CLICKED", target: "UNIQUE VISITORS", value: clickedLinks, type: "success" }
                ]
            };

            // Create sankey generator
            const sankeyGenerator = d3.sankey()
                .nodeId(d => d.id)
                .nodeWidth(12)
                .nodePadding(30)
                .extent([[40, 20], [width - 40, height - 20]]);

            const graph = sankeyGenerator({
                nodes: data.nodes.map(d => Object.assign({}, d)),
                links: data.links.map(d => Object.assign({}, d))
            });

            const tooltip = d3.select('#sankeyTooltip');

            // Scientific color scheme - green for success, red for failure
            const nodeColors = {
                "TOTAL LINKS": "rgba(100, 100, 100, 0.7)",
                "CLICKED": "rgba(34, 197, 94, 0.7)",      // Green transparent
                "NOT CLICKED": "rgba(239, 68, 68, 0.7)",  // Red transparent
                "UNIQUE VISITORS": "rgba(34, 197, 94, 0.9)" // Brighter green
            };

            const linkColors = {
                "success": "rgba(34, 197, 94, 0.4)",  // Green transparent for success flows
                "failure": "rgba(239, 68, 68, 0.4)"   // Red transparent for failure flows
            };

            // Draw links
            svg.append('g')
                .selectAll('path')
                .data(graph.links)
                .join('path')
                    .attr('class', 'sankey-link')
                    .attr('d', d3.sankeyLinkHorizontal())
                    .attr('stroke-width', d => Math.max(2, d.width))
                    .attr('stroke', d => linkColors[d.type])
                    .on('mousemove', (event, d) => {
                        const percentage = d.source.value > 0 ? ((d.value / d.source.value) * 100).toFixed(1) : 0;
                        tooltip.style('display', 'block')
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY + 10) + 'px')
                            .html(`${d.source.id} → ${d.target.id}<br><strong>${d.value.toLocaleString()}</strong> (${percentage}%)`);
                    })
                    .on('mouseout', () => tooltip.style('display', 'none'));

            // Draw nodes
            const node = svg.append('g')
                .selectAll('.sankey-node')
                .data(graph.nodes)
                .join('g')
                    .attr('class', 'sankey-node')
                    .attr('transform', d => `translate(${d.x0},${d.y0})`);

            node.append('rect')
                .attr('height', d => Math.max(2, d.y1 - d.y0))
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', d => nodeColors[d.id])
                .on('mousemove', (event, d) => {
                    const percentage = totalLinks > 0 ? ((d.value / totalLinks) * 100).toFixed(1) : 0;
                    tooltip.style('display', 'block')
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY + 10) + 'px')
                        .html(`<strong>${d.id}</strong><br>n = ${d.value.toLocaleString()} (${percentage}%)`);
                })
                .on('mouseout', () => tooltip.style('display', 'none'));

            // Add labels
            node.append('text')
                .attr('x', -8)
                .attr('y', d => (d.y1 - d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'end')
                .text(d => d.id)
                .filter(d => d.x0 < width / 2)
                .attr('x', d => d.x1 - d.x0 + 8)
                .attr('text-anchor', 'start');

            // Add value labels with scientific notation (n = X)
            node.append('text')
                .attr('x', -8)
                .attr('y', d => (d.y1 - d.y0) / 2 + 14)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'end')
                .attr('fill', '#666')
                .attr('font-size', '9px')
                .attr('font-family', 'Courier New, monospace')
                .text(d => `n = ${d.value.toLocaleString()}`)
                .filter(d => d.x0 < width / 2)
                .attr('x', d => d.x1 - d.x0 + 8)
                .attr('text-anchor', 'start');
        }

        // Render top clickers data with white → yellow → orange → red gradient
        function renderGeoData(geoData) {
            const maxClicks = Math.max(...geoData.map(g => g.clicks), 1);

            // Helper function for gradient color based on intensity (white → yellow → orange → red)
            function getBarColor(intensity) {
                const colors = [
                    { threshold: 0, color: '#FFFFFF' },      // Blanc pur
                    { threshold: 0.1, color: '#FEF3C7' },    // Jaune très pâle
                    { threshold: 0.2, color: '#FDE68A' },    // Jaune clair
                    { threshold: 0.3, color: '#FCD34D' },    // Jaune
                    { threshold: 0.4, color: '#FBBF24' },    // Jaune orangé
                    { threshold: 0.5, color: '#F59E0B' },    // Orange clair
                    { threshold: 0.6, color: '#FB923C' },    // Orange
                    { threshold: 0.7, color: '#F97316' },    // Orange vif
                    { threshold: 0.8, color: '#EF4444' },    // Rouge
                    { threshold: 0.9, color: '#DC2626' },    // Rouge foncé
                    { threshold: 0.95, color: '#B91C1C' },   // Rouge très foncé
                    { threshold: 1.0, color: '#7F1D1D' }     // Rouge bordeaux
                ];

                for (let i = 0; i < colors.length - 1; i++) {
                    if (intensity >= colors[i].threshold && intensity <= colors[i + 1].threshold) {
                        return colors[i].color;
                    }
                }
                return colors[colors.length - 1].color;
            }

            const html = geoData.map((geo, index) => {
                const intensity = geo.clicks / maxClicks;
                const barColor = getBarColor(intensity);
                const fullName = `${geo.first_name} ${geo.last_name}`;

                return `
                <li class="geo-item">
                    <span class="geo-rank">${index + 1}</span>
                    <span class="geo-person">${fullName}</span>
                    <div class="geo-bar">
                        <div class="geo-bar-fill" style="width: ${(geo.clicks / maxClicks) * 100}%; background: ${barColor};"></div>
                    </div>
                    <span class="geo-count">${geo.clicks}</span>
                </li>
            `}).join('');

            document.getElementById('geoList').innerHTML = html || '<li class="loading">No data</li>';
        }

        // Load timeline
        async function loadTimeline() {
            try {
                let url = `/api/analytics/timeline?range=${currentRange}`;
                if (currentCampaign) {
                    url += `&campaign=${currentCampaign}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                const ctx = document.getElementById('timelineChart');

                if (timelineChart) {
                    timelineChart.destroy();
                }

                timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.period),
                        datasets: [
                            {
                                label: 'Unique Visitors',
                                data: data.map(d => d.unique_visitors),
                                borderColor: 'rgba(16, 185, 129, 1)',        // Scientific green
                                backgroundColor: 'rgba(16, 185, 129, 0.15)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5,
                                pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                                pointBorderColor: '#0a0a0a',
                                pointBorderWidth: 2
                            },
                            {
                                label: 'Total Clicks',
                                data: data.map(d => d.total_clicks),
                                borderColor: 'rgba(59, 130, 246, 1)',        // Scientific blue
                                backgroundColor: 'rgba(59, 130, 246, 0.15)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5,
                                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                                pointBorderColor: '#0a0a0a',
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end',
                                labels: {
                                    color: '#e5e5e5',
                                    font: {
                                        size: 11,
                                        family: "'Inter', sans-serif",
                                        weight: '500'
                                    },
                                    padding: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#222'
                                },
                                ticks: {
                                    color: '#888'
                                }
                            },
                            x: {
                                grid: {
                                    color: '#222'
                                },
                                ticks: {
                                    color: '#888'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading timeline:', error);
            }
        }

        // Load heatmap
        async function loadHeatmap() {
            try {
                let url = `/api/heatmap?range=${currentRange}`;
                if (currentCampaign) {
                    url += `&campaign=${currentCampaign}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                renderHeatmap(data);
            } catch (error) {
                console.error('Error loading heatmap:', error);
            }
        }

        // Render heatmap
        function renderHeatmap(data) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const dayIndices = [1, 2, 3, 4, 5, 6, 0]; // Map to actual day_of_week values
            const hours = Array.from({length: 24}, (_, i) => i);

            // Create matrix
            const matrix = {};
            hours.forEach(hour => {
                matrix[hour] = {};
                dayIndices.forEach(dayIndex => {
                    matrix[hour][dayIndex] = 0;
                });
            });

            // Fill with data
            data.forEach(item => {
                const day = parseInt(item.day_of_week);
                const hour = parseInt(item.hour);
                if (!matrix[hour]) matrix[hour] = {};
                matrix[hour][day] = parseInt(item.click_count);
            });

            // Find max for scaling
            const maxClicks = Math.max(...data.map(d => parseInt(d.click_count)), 1);

            // Color gradient function: white -> yellow -> orange -> red -> dark red with smooth transitions
            function getHeatColor(intensity) {
                if (intensity === 0) return '#1a1a1a'; // Fond sombre pour 0

                // Dégradé blanc → jaune → orange → rouge → rouge foncé avec plus de nuances
                const colors = [
                    { threshold: 0, color: '#FFFFFF' },      // Blanc pur
                    { threshold: 0.1, color: '#FEF3C7' },    // Jaune très pâle
                    { threshold: 0.2, color: '#FDE68A' },    // Jaune clair
                    { threshold: 0.3, color: '#FCD34D' },    // Jaune
                    { threshold: 0.4, color: '#FBBF24' },    // Jaune orangé
                    { threshold: 0.5, color: '#F59E0B' },    // Orange clair
                    { threshold: 0.6, color: '#FB923C' },    // Orange
                    { threshold: 0.7, color: '#F97316' },    // Orange vif
                    { threshold: 0.8, color: '#EF4444' },    // Rouge
                    { threshold: 0.9, color: '#DC2626' },    // Rouge foncé
                    { threshold: 0.95, color: '#B91C1C' },   // Rouge très foncé
                    { threshold: 1.0, color: '#7F1D1D' }     // Rouge bordeaux
                ];

                // Trouver les deux couleurs entre lesquelles interpoler
                for (let i = 0; i < colors.length - 1; i++) {
                    if (intensity >= colors[i].threshold && intensity <= colors[i + 1].threshold) {
                        const start = colors[i];
                        const end = colors[i + 1];
                        const localRatio = (intensity - start.threshold) / (end.threshold - start.threshold);

                        // Interpoler entre les deux couleurs
                        const startRGB = hexToRgb(start.color);
                        const endRGB = hexToRgb(end.color);

                        const r = Math.round(startRGB.r + (endRGB.r - startRGB.r) * localRatio);
                        const g = Math.round(startRGB.g + (endRGB.g - startRGB.g) * localRatio);
                        const b = Math.round(startRGB.b + (endRGB.b - startRGB.b) * localRatio);

                        return `rgb(${r}, ${g}, ${b})`;
                    }
                }

                return colors[colors.length - 1].color;
            }

            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : { r: 0, g: 0, b: 0 };
            }

            // Build HTML
            let html = '<div class="heatmap-grid">';

            // Empty cell for top-left corner
            html += '<div></div>';

            // Day headers (horizontal)
            days.forEach(day => {
                html += `<div class="heatmap-day">${day}</div>`;
            });

            // Rows (hours in vertical)
            hours.forEach(hour => {
                html += `<div class="heatmap-label">${hour}:00</div>`;
                dayIndices.forEach(dayIndex => {
                    const count = matrix[hour][dayIndex] || 0;
                    const intensity = count / maxClicks;
                    const color = getHeatColor(intensity);
                    html += `<div class="heatmap-cell" style="background: ${color}" title="${days[dayIndices.indexOf(dayIndex)]} ${hour}:00 - ${count} clicks"></div>`;
                });
            });

            html += '</div>';
            document.getElementById('heatmapContainer').innerHTML = html;
        }

        // Load clicks
        async function loadClicks() {
            try {
                const url = currentCampaign ? `/api/clicks?campaign=${currentCampaign}` : '/api/clicks';
                const response = await fetch(url);
                allClicks = await response.json();

                renderClicksTable(allClicks);
            } catch (error) {
                console.error('Error loading clicks:', error);
            }
        }

        // Render clicks table
        function renderClicksTable(clicks) {
            const tbody = document.getElementById('clicksTable');

            if (clicks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">No data</td></tr>';
                return;
            }

            tbody.innerHTML = clicks.map(click => `
                <tr>
                    <td><strong>${click.first_name} ${click.last_name}</strong></td>
                    <td>${click.email || '-'}</td>
                    <td><span class="badge badge-gray">${click.icp || 'Non défini'}</span></td>
                    <td><span class="badge badge-campaign">${click.campaign}</span></td>
                    <td><span class="click-count">${click.click_count}</span></td>
                    <td>${click.first_clicked ? formatDate(click.first_clicked) : '-'}</td>
                    <td>${click.last_clicked ? formatDate(click.last_clicked) : '-'}</td>
                    <td>${click.click_count > 0 ? '<span class="badge badge-success">Clicked</span>' : '<span class="badge badge-gray">Not clicked</span>'}</td>
                    <td><button class="delete-btn" onclick="deleteLink('${click.link_id}')">Delete</button></td>
                </tr>
            `).join('');
        }

        // Delete link
        async function deleteLink(linkId) {
            if (!confirm('Are you sure you want to delete this link and all its associated clicks?')) {
                return;
            }

            try {
                const response = await fetch(`/api/links/${linkId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Reload only necessary data without resetting campaign selection
                    await Promise.all([
                        loadAnalytics(),
                        loadTimeline(),
                        loadHeatmap(),
                        loadClicks(),
                        loadICPStats()
                    ]);
                    // Only reload campaigns if we might have deleted the last link in a campaign
                    await loadCampaigns();
                } else {
                    alert('Error deleting link');
                }
            } catch (error) {
                console.error('Error deleting link:', error);
                alert('Error deleting link');
            }
        }

        // Load campaigns
        async function loadCampaigns() {
            try {
                const response = await fetch('/api/campaigns');
                const campaigns = await response.json();

                const select = document.getElementById('globalCampaignFilter');

                // Save current selection
                const previousSelection = currentCampaign || select.value;

                // Clear existing options
                select.innerHTML = '';
                campaigns.forEach(campaign => {
                    const option = document.createElement('option');
                    option.value = campaign;
                    option.textContent = campaign;
                    select.appendChild(option);
                });

                // Restore previous selection if it still exists
                if (previousSelection && campaigns.includes(previousSelection)) {
                    currentCampaign = previousSelection;
                    select.value = previousSelection;
                    localStorage.setItem('selectedCampaign', currentCampaign);
                } else if (campaigns.length > 0) {
                    // Only set first campaign as default on initial load
                    currentCampaign = campaigns[0];
                    select.value = campaigns[0];
                    localStorage.setItem('selectedCampaign', currentCampaign);
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
            }
        }

        // Load ICP stats and render pie chart
        async function loadICPStats() {
            try {
                let url = `/api/icp-stats?range=${currentRange}`;
                if (currentCampaign) {
                    url += `&campaign=${currentCampaign}`;
                }
                const response = await fetch(url);
                const icpData = await response.json();

                renderICPChart(icpData);
            } catch (error) {
                console.error('Error loading ICP stats:', error);
            }
        }

        // Render ICP pie chart
        function renderICPChart(icpData) {
            const ctx = document.getElementById('icpChart');

            // Destroy existing chart
            if (icpChart) {
                icpChart.destroy();
            }

            if (icpData.length === 0) {
                // No data to display
                return;
            }

            // Scientific color palette with transparency - Blue/Green gradient
            const colors = [
                'rgba(16, 185, 129, 0.75)',   // Green - primary
                'rgba(34, 197, 94, 0.75)',    // Emerald
                'rgba(59, 130, 246, 0.75)',   // Blue - secondary
                'rgba(14, 165, 233, 0.75)',   // Sky blue
                'rgba(5, 150, 105, 0.75)',    // Darker green
                'rgba(37, 99, 235, 0.75)',    // Darker blue
                'rgba(16, 185, 129, 0.6)',    // Green lighter
                'rgba(59, 130, 246, 0.6)',    // Blue lighter
                'rgba(20, 184, 166, 0.75)',   // Teal
                'rgba(79, 70, 229, 0.75)'     // Indigo
            ];

            const borderColors = [
                'rgba(16, 185, 129, 1)',
                'rgba(34, 197, 94, 1)',
                'rgba(59, 130, 246, 1)',
                'rgba(14, 165, 233, 1)',
                'rgba(5, 150, 105, 1)',
                'rgba(37, 99, 235, 1)',
                'rgba(16, 185, 129, 1)',
                'rgba(59, 130, 246, 1)',
                'rgba(20, 184, 166, 1)',
                'rgba(79, 70, 229, 1)'
            ];

            const labels = icpData.map(d => d.icp);
            const data = icpData.map(d => d.click_count);
            const backgroundColors = icpData.map((_, i) => colors[i % colors.length]);
            const borderColorsMap = icpData.map((_, i) => borderColors[i % borderColors.length]);

            icpChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColorsMap,
                        borderWidth: 2,
                        hoverOffset: 8,
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e5e5e5',
                                font: {
                                    size: 11,
                                    family: "'Inter', sans-serif"
                                },
                                padding: 12,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Export CSV
        function exportCSV() {
            const headers = ['First Name', 'Last Name', 'Email', 'ICP', 'Campaign', 'Clicks', 'First Click', 'Last Click', 'Status'];
            const rows = allClicks.map(click => [
                click.first_name,
                click.last_name,
                click.email || '',
                click.icp || 'Non défini',
                click.campaign,
                click.click_count,
                click.first_clicked ? formatDate(click.first_clicked) : '',
                click.last_clicked ? formatDate(click.last_clicked) : '',
                click.click_count > 0 ? 'Clicked' : 'Not clicked'
            ]);

            const csv = [headers, ...rows].map(row => row.join(',')).join('\\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clicks_export_${Date.now()}.csv`;
            a.click();
        }

        // Restore UI state on page load
        function restoreUIState() {
            // Restore time range button active state
            document.querySelectorAll('.time-btn').forEach(btn => {
                if (btn.dataset.range === currentRange) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Initial load
        restoreUIState();
        loadAllData();

        // Auto refresh every 30s
        setInterval(loadAllData, 30000);
    </script>
</body>
</html>
